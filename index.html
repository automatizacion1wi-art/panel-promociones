<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Promociones DX-RAY</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶∑</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; }
        .section-hidden { display: none; }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
        }

        .toast-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .toast-error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .toast-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .toast-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.hiding {
            animation: slideOut 0.3s ease-out forwards;
        }

        .badge-vencida {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }

        .sin-horario {
            background: #fef3c7;
            color: #92400e;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">ü¶∑ Dashboard DX-RAY</h1>
                    <p class="text-blue-100">Gesti√≥n de Promociones y Sucursales</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="sincronizarDentalink()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
                        <i class="fas fa-sync" id="iconSync"></i>
                        Sync Dentalink
                    </button>
                    <button onclick="recargarDatos()" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
                        <i class="fas fa-sync-alt" id="iconRecargar"></i>
                        Recargar
                    </button>
                </div>
            </div>
        </header>

        <!-- Navegaci√≥n por pesta√±as -->
        <div class="bg-white shadow-md border-b">
            <div class="container mx-auto px-6">
                <nav class="flex gap-8">
                    <button onclick="cambiarSeccion('dashboard')" id="tab-dashboard" class="tab-active py-4 px-2 font-medium transition">
                        <i class="fas fa-chart-line mr-2"></i>Dashboard
                    </button>
                    <button onclick="cambiarSeccion('promociones')" id="tab-promociones" class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600 transition">
                        <i class="fas fa-tags mr-2"></i>Promociones
                    </button>
                    <button onclick="cambiarSeccion('sucursales')" id="tab-sucursales" class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600 transition">
                        <i class="fas fa-building mr-2"></i>Sucursales
                    </button>
                </nav>
            </div>
        </div>

        <div class="container mx-auto px-6 py-8">

            <!-- SECCI√ìN: DASHBOARD -->
            <div id="section-dashboard">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Total Promociones</p>
                                <p class="text-3xl font-bold text-gray-800" id="totalPromos">0</p>
                            </div>
                            <div class="bg-blue-100 rounded-full p-3">
                                <i class="fas fa-tags text-blue-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Promociones Activas</p>
                                <p class="text-3xl font-bold text-gray-800" id="promosActivas">0</p>
                            </div>
                            <div class="bg-green-100 rounded-full p-3">
                                <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-red-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Promociones Inactivas</p>
                                <p class="text-3xl font-bold text-gray-800" id="promosInactivas">0</p>
                            </div>
                            <div class="bg-red-100 rounded-full p-3">
                                <i class="fas fa-times-circle text-red-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-purple-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Sucursales Activas</p>
                                <p class="text-3xl font-bold text-gray-800" id="totalSucursales">0</p>
                            </div>
                            <div class="bg-purple-100 rounded-full p-3">
                                <i class="fas fa-building text-purple-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Promociones por Sucursal -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üìä Promociones por Sucursal</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sucursal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ciudad</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Promos</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Activas</th>
                                </tr>
                            </thead>
                            <tbody id="tablaSucursalesPromos" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN: PROMOCIONES -->
            <div id="section-promociones" class="section-hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">üìã Gesti√≥n de Promociones</h3>
                        <button onclick="mostrarFormNuevaPromocion()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
                            <i class="fas fa-plus"></i>
                            Nueva Promoci√≥n
                        </button>
                    </div>

                    <!-- Filtros -->
                    <div class="mb-4 flex gap-4 flex-wrap">
                        <select id="filtroSucursal" onchange="filtrarPromociones()" class="border border-gray-300 rounded-lg px-4 py-2">
                            <option value="">Todas las sucursales</option>
                        </select>
                        <select id="filtroEstado" onchange="filtrarPromociones()" class="border border-gray-300 rounded-lg px-4 py-2">
                            <option value="">Todos los estados</option>
                            <option value="true">Activas</option>
                            <option value="false">Inactivas</option>
                        </select>
                        <input type="text" id="buscarPromo" placeholder="Buscar promoci√≥n..." onkeyup="filtrarPromociones()" class="border border-gray-300 rounded-lg px-4 py-2 flex-1 min-w-[200px]">
                    </div>

                    <!-- Selector de items por p√°gina -->
                    <div class="mb-4 flex items-center gap-2">
                        <label class="text-sm text-gray-600">Mostrar:</label>
                        <select id="itemsPorPagina" onchange="cambiarItemsPorPagina()" class="border border-gray-300 rounded px-3 py-1 text-sm">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span class="text-sm text-gray-600">registros</span>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descripci√≥n</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Precio</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vigencia</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Creada</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sucursales</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaPromociones" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginaci√≥n -->
                    <div class="mt-4 flex justify-between items-center">
                        <div class="text-sm text-gray-600" id="infoPromos"></div>
                        <div class="flex gap-2" id="paginacionPromos"></div>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN: SUCURSALES -->
            <div id="section-sucursales" class="section-hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">üè• Gesti√≥n de Sucursales</h3>
                        <div class="flex gap-3">
                            <button onclick="sincronizarDentalink()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
                                <i class="fas fa-sync"></i>
                                Sync Dentalink
                            </button>
                            <button onclick="mostrarFormNuevaSucursal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
                                <i class="fas fa-plus"></i>
                                Nueva Sucursal
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ciudad</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tel√©fono</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Horarios</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Promociones</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaSucursales" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal Nueva/Editar Promoci√≥n -->
    <div id="modalPromocion" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800" id="tituloModalPromo">‚ûï Nueva Promoci√≥n</h3>
                <button onclick="cerrarModalPromocion()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="formPromocion" onsubmit="guardarPromocion(event)">
                <input type="hidden" id="idPromocionEditar">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n</label>
                        <textarea id="descripcion" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Precio</label>
                            <input type="number" id="precio" step="0.01" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                            <select id="activa" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="true">Activa</option>
                                <option value="false">Inactiva</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-calendar-alt text-blue-600"></i> Fecha Inicio (opcional)
                            </label>
                            <input type="date" id="fechaInicio" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-calendar-check text-red-600"></i> Fecha Fin (opcional)
                            </label>
                            <input type="date" id="fechaFin" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 bg-blue-50 p-3 rounded">
                        <i class="fas fa-info-circle text-blue-600"></i> 
                        <strong>Nota:</strong> Si estableces fecha de fin, la promoci√≥n se desactivar√° autom√°ticamente al pasar esa fecha.
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Asignar a Sucursales</label>
                        <div class="flex gap-2 mb-2">
                            <button type="button" onclick="seleccionarTodasSucursales()" class="text-sm text-blue-600 hover:text-blue-800">
                                <i class="fas fa-check-square"></i> Seleccionar todas
                            </button>
                            <button type="button" onclick="deseleccionarTodasSucursales()" class="text-sm text-gray-600 hover:text-gray-800">
                                <i class="fas fa-square"></i> Deseleccionar todas
                            </button>
                        </div>
                        <div id="checkboxesSucursales" class="space-y-2 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-4 bg-gray-50">
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                    <button type="button" onclick="cerrarModalPromocion()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-medium transition">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Nueva/Editar Sucursal -->
    <div id="modalSucursal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800" id="tituloModalSucursal">‚ûï Nueva Sucursal</h3>
                <button onclick="cerrarModalSucursal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="formSucursal" onsubmit="guardarSucursal(event)">
                <input type="hidden" id="idSucursalEditar">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ID Sucursal (Dentalink)</label>
                        <input type="number" id="idSucursalManual" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Este ID debe coincidir con el ID de Dentalink</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de la Sucursal</label>
                        <input type="text" id="nombreSucursal" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ciudad</label>
                        <input type="text" id="ciudadSucursal" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Direcci√≥n</label>
                        <textarea id="direccionSucursal" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500" rows="2"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tel√©fono</label>
                        <input type="text" id="telefonoSucursal" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Horarios (opcional)
                            <span class="text-xs text-yellow-600 ml-2">‚ö†Ô∏è Se mostrar√° advertencia si est√° vac√≠o</span>
                        </label>
                        <input type="text" id="horariosSucursal" placeholder="Ej: Lunes a Viernes 10:00 - 19:00" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                        <select id="activaSucursal" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                            <option value="true">Activa</option>
                            <option value="false">Inactiva</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                    <button type="button" onclick="cerrarModalSucursal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-medium transition">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://sdqmuabsdsghptbttwiy.supabase.co/rest/v1';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkcW11YWJzZHNnaHB0YnR0d2l5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MTQ2NjMsImV4cCI6MjA4NTk5MDY2M30.Ki1AazQ5A7QcQuA0wUOjujGAGn1k749VRK2qoD7vNR0';

        // üîß CONFIGURA AQU√ç TU TOKEN DE DENTALINK
        const DENTALINK_API_URL = 'https://api.dentalink.healthatom.com/api/v1/sucursales';
        const DENTALINK_TOKEN = 'uLDY8zgT9Oa10nDXSr8PPCou8MFT4BPNjwlYMcEX.c24YdKRkDONJW7nXcdQhx6VLEvsbxVFWia4FXmXh'; // ‚ö†Ô∏è Coloca aqu√≠ tu token de Dentalink

        const headers = {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
        };

        let promociones = [];
        let sucursales = [];
        let relaciones = [];
        let promocionesFiltradas = [];
        let paginaActual = 1;
        let itemsPorPagina = 10;

        document.addEventListener('DOMContentLoaded', () => {
            cargarDatos();
            setInterval(verificarPromocionesVencidas, 60000);
        });

        function mostrarToast(mensaje, tipo = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${tipo}`;

            const iconos = {
                success: '<i class="fas fa-check-circle text-2xl"></i>',
                error: '<i class="fas fa-exclamation-circle text-2xl"></i>',
                warning: '<i class="fas fa-exclamation-triangle text-2xl"></i>',
                info: '<i class="fas fa-info-circle text-2xl"></i>'
            };

            toast.innerHTML = `
                ${iconos[tipo]}
                <span class="font-medium">${mensaje}</span>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function recargarDatos() {
            const icon = document.getElementById('iconRecargar');
            icon.classList.add('fa-spin');

            await cargarDatos();

            setTimeout(() => {
                icon.classList.remove('fa-spin');
                mostrarToast('Datos actualizados correctamente', 'success');
            }, 500);
        }

        async function cargarDatos() {
            try {
                await Promise.all([
                    cargarSucursales(),
                    cargarPromociones(),
                    cargarRelaciones()
                ]);
                actualizarUI();
            } catch (error) {
                console.error('Error cargando datos:', error);
                mostrarToast('Error al cargar los datos', 'error');
            }
        }

        async function cargarSucursales() {
            const response = await fetch(`${SUPABASE_URL}/sucursales?select=*&order=id_sucursal.asc`, { headers });
            sucursales = await response.json();
            llenarSelectSucursales();
        }

        async function cargarPromociones() {
            const response = await fetch(`${SUPABASE_URL}/promociones?select=*&order=created_at.desc`, { headers });
            promociones = await response.json();
            aplicarFiltrosActuales();
        }

        async function cargarRelaciones() {
            const response = await fetch(`${SUPABASE_URL}/sucursal_promocion?select=*`, { headers });
            relaciones = await response.json();
        }

        async function verificarPromocionesVencidas() {
            const hoy = new Date().toISOString().split('T')[0];
            let desactivadas = 0;

            for (const promo of promociones) {
                if (promo.activa && promo.fecha_fin && promo.fecha_fin < hoy) {
                    try {
                        await fetch(`${SUPABASE_URL}/promociones?id_promocion=eq.${promo.id_promocion}`, {
                            method: 'PATCH',
                            headers,
                            body: JSON.stringify({ activa: false })
                        });
                        desactivadas++;
                    } catch (error) {
                        console.error('Error desactivando promoci√≥n vencida:', error);
                    }
                }
            }

            if (desactivadas > 0) {
                await cargarDatos();
                mostrarToast(`${desactivadas} promoci√≥n(es) vencida(s) desactivada(s)`, 'warning');
            }
        }

        // üîÑ SINCRONIZACI√ìN CON DENTALINK - HORARIOS NO SE ACTUALIZAN
        async function sincronizarDentalink() {
            if (!DENTALINK_TOKEN) {
                mostrarToast('‚ö†Ô∏è Configura el token de Dentalink en el c√≥digo', 'error');
                return;
            }

            const icon = document.getElementById('iconSync');
            icon.classList.add('fa-spin');

            try {
                const response = await fetch(DENTALINK_API_URL, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Token ${DENTALINK_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const resultado = await response.json();
                const sucursalesDentalink = resultado.data || [];

                let nuevas = 0;
                let actualizadas = 0;
                let sinHorario = 0;

                for (const sucDental of sucursalesDentalink) {
                    const existe = sucursales.find(s => s.id_sucursal === sucDental.id);

                    if (!existe) {
                        // ‚úÖ NUEVA SUCURSAL - se crea con horarios = NULL
                        const datos = {
                            id_sucursal: sucDental.id,
                            nombre_sucursal: sucDental.nombre,
                            ciudad: sucDental.ciudad || sucDental.comuna || 'Sin ciudad',
                            direccion: sucDental.direccion,
                            telefono: sucDental.telefono,
                            horarios: null, // NULL - se debe agregar manualmente desde el dashboard
                            activa: sucDental.habilitada === 1
                        };

                        await fetch(`${SUPABASE_URL}/sucursales`, {
                            method: 'POST',
                            headers,
                            body: JSON.stringify(datos)
                        });
                        nuevas++;
                        sinHorario++;
                    } else {
                        // üîÑ ACTUALIZACI√ìN - horarios NO se toca, solo otros campos
                        const datosActualizar = {
                            nombre_sucursal: sucDental.nombre,
                            ciudad: sucDental.ciudad || sucDental.comuna || 'Sin ciudad',
                            direccion: sucDental.direccion,
                            telefono: sucDental.telefono,
                            activa: sucDental.habilitada === 1
                            // ‚ö†Ô∏è horarios NO se incluye en la actualizaci√≥n
                        };

                        await fetch(`${SUPABASE_URL}/sucursales?id_sucursal=eq.${sucDental.id}`, {
                            method: 'PATCH',
                            headers,
                            body: JSON.stringify(datosActualizar)
                        });
                        actualizadas++;
                    }
                }

                await cargarDatos();
                icon.classList.remove('fa-spin');

                let mensaje = `Sync completado: ${nuevas} nuevas, ${actualizadas} actualizadas`;
                if (sinHorario > 0) {
                    mensaje += `. ‚ö†Ô∏è ${sinHorario} sucursal(es) sin horario`;
                    mostrarToast(mensaje, 'warning');
                } else {
                    mostrarToast(mensaje, 'success');
                }

            } catch (error) {
                console.error('Error en sync:', error);
                icon.classList.remove('fa-spin');
                mostrarToast(`Error: ${error.message}`, 'error');
            }
        }

        function aplicarFiltrosActuales() {
            const sucursalId = document.getElementById('filtroSucursal')?.value || '';
            const estado = document.getElementById('filtroEstado')?.value || '';
            const busqueda = document.getElementById('buscarPromo')?.value.toLowerCase() || '';

            promocionesFiltradas = promociones.filter(promo => {
                if (sucursalId) {
                    const tieneRelacion = relaciones.some(r => 
                        r.id_promocion === promo.id_promocion && 
                        r.id_sucursal == sucursalId
                    );
                    if (!tieneRelacion) return false;
                }

                if (estado !== '') {
                    if (promo.activa.toString() !== estado) return false;
                }

                if (busqueda) {
                    if (!promo.descripcion.toLowerCase().includes(busqueda)) return false;
                }

                return true;
            });
        }

        function actualizarUI() {
            actualizarStats();
            renderizarTablaPromociones();
            renderizarTablaSucursales();
            renderizarPromosPorSucursal();
        }

        function actualizarStats() {
            document.getElementById('totalPromos').textContent = promociones.length;
            document.getElementById('promosActivas').textContent = promociones.filter(p => p.activa).length;
            document.getElementById('promosInactivas').textContent = promociones.filter(p => !p.activa).length;
            document.getElementById('totalSucursales').textContent = sucursales.filter(s => s.activa !== false).length;
        }

        function cambiarSeccion(seccion) {
            cargarDatos();

            document.getElementById('section-dashboard').classList.add('section-hidden');
            document.getElementById('section-promociones').classList.add('section-hidden');
            document.getElementById('section-sucursales').classList.add('section-hidden');

            document.getElementById('tab-dashboard').classList.remove('tab-active');
            document.getElementById('tab-promociones').classList.remove('tab-active');
            document.getElementById('tab-sucursales').classList.remove('tab-active');

            document.getElementById(`section-${seccion}`).classList.remove('section-hidden');
            document.getElementById(`tab-${seccion}`).classList.add('tab-active');
        }

        function cambiarItemsPorPagina() {
            itemsPorPagina = parseInt(document.getElementById('itemsPorPagina').value);
            paginaActual = 1;
            renderizarTablaPromociones();
        }

        function formatearFecha(fecha) {
            if (!fecha) return '-';
            const [year, month, day] = fecha.split('-');
            return `${day}/${month}/${year}`;
        }

        function formatearFechaCreacion(timestamp) {
            if (!timestamp) return '-';
            const fecha = new Date(timestamp);
            return fecha.toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function estaVencida(fechaFin) {
            if (!fechaFin) return false;
            const hoy = new Date().toISOString().split('T')[0];
            return fechaFin < hoy;
        }

        function renderizarTablaPromociones() {
            const tbody = document.getElementById('tablaPromociones');
            if (promocionesFiltradas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No hay promociones</td></tr>';
                document.getElementById('infoPromos').textContent = '';
                document.getElementById('paginacionPromos').innerHTML = '';
                return;
            }

            const totalPaginas = Math.ceil(promocionesFiltradas.length / itemsPorPagina);
            const inicio = (paginaActual - 1) * itemsPorPagina;
            const fin = inicio + itemsPorPagina;
            const promosPagina = promocionesFiltradas.slice(inicio, fin);

            tbody.innerHTML = promosPagina.map(promo => {
                const sucursalesAsignadas = relaciones.filter(r => r.id_promocion === promo.id_promocion);
                const vencida = estaVencida(promo.fecha_fin);
                const vigencia = promo.fecha_inicio || promo.fecha_fin 
                    ? `${formatearFecha(promo.fecha_inicio)} - ${formatearFecha(promo.fecha_fin)}`
                    : 'Sin l√≠mite';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm text-gray-900">
                            ${promo.descripcion.substring(0, 50)}${promo.descripcion.length > 50 ? '...' : ''}
                            ${vencida && promo.activa ? '<span class="badge-vencida">VENCIDA</span>' : ''}
                        </td>
                        <td class="px-6 py-4 text-sm font-semibold text-green-600">$${Number(promo.precio).toFixed(2)}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full ${promo.activa ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${promo.activa ? '‚úì Activa' : '‚úó Inactiva'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-xs text-gray-600">${vigencia}</td>
                        <td class="px-6 py-4 text-xs text-gray-500">${formatearFechaCreacion(promo.created_at)}</td>
                        <td class="px-6 py-4 text-sm font-semibold text-blue-600">${sucursalesAsignadas.length}</td>
                        <td class="px-6 py-4 flex gap-2">
                            <button onclick="editarPromocion(${promo.id_promocion})" 
                                    class="text-blue-600 hover:text-blue-800 text-lg" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="toggleEstadoPromo(${promo.id_promocion}, ${promo.activa})" 
                                    class="text-orange-600 hover:text-orange-800 text-lg" title="Cambiar estado">
                                <i class="fas fa-toggle-${promo.activa ? 'on' : 'off'}"></i>
                            </button>
                            <button onclick="eliminarPromo(${promo.id_promocion})" 
                                    class="text-red-600 hover:text-red-800 text-lg" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('infoPromos').textContent = `Mostrando ${inicio + 1} - ${Math.min(fin, promocionesFiltradas.length)} de ${promocionesFiltradas.length} promociones`;

            let paginacionHTML = '';
            if (paginaActual > 1) {
                paginacionHTML += `<button onclick="cambiarPagina(${paginaActual - 1})" class="px-3 py-1 border rounded hover:bg-gray-100">Anterior</button>`;
            }
            for (let i = 1; i <= totalPaginas; i++) {
                if (i === paginaActual) {
                    paginacionHTML += `<button class="px-3 py-1 border rounded bg-blue-600 text-white">${i}</button>`;
                } else if (Math.abs(i - paginaActual) <= 2 || i === 1 || i === totalPaginas) {
                    paginacionHTML += `<button onclick="cambiarPagina(${i})" class="px-3 py-1 border rounded hover:bg-gray-100">${i}</button>`;
                } else if (Math.abs(i - paginaActual) === 3) {
                    paginacionHTML += `<span class="px-2">...</span>`;
                }
            }
            if (paginaActual < totalPaginas) {
                paginacionHTML += `<button onclick="cambiarPagina(${paginaActual + 1})" class="px-3 py-1 border rounded hover:bg-gray-100">Siguiente</button>`;
            }
            document.getElementById('paginacionPromos').innerHTML = paginacionHTML;
        }

        function cambiarPagina(pagina) {
            paginaActual = pagina;
            renderizarTablaPromociones();
        }

        function renderizarTablaSucursales() {
            const tbody = document.getElementById('tablaSucursales');
            tbody.innerHTML = sucursales.map(suc => {
                const cantPromos = relaciones.filter(r => r.id_sucursal === suc.id_sucursal).length;
                const activa = suc.activa !== false;
                const sinHorario = !suc.horarios;

                return `
                <tr class="hover:bg-gray-50 ${!activa ? 'opacity-60' : ''}">
                    <td class="px-6 py-4 text-sm font-bold text-blue-600">${suc.id_sucursal}</td>
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${suc.nombre_sucursal}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${suc.ciudad || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${suc.telefono || '-'}</td>
                    <td class="px-6 py-4 text-xs ${sinHorario ? 'text-yellow-700' : 'text-gray-500'}">
                        ${sinHorario 
                            ? '<span class="sin-horario">‚ö†Ô∏è Sin horario</span>' 
                            : (suc.horarios.substring(0, 30) + '...')}
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${activa ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${activa ? '‚úì Activa' : '‚úó Inactiva'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm font-semibold text-blue-600">${cantPromos}</td>
                    <td class="px-6 py-4 flex gap-2">
                        <button onclick="editarSucursal(${suc.id_sucursal})" 
                                class="text-blue-600 hover:text-blue-800 text-lg" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="toggleEstadoSucursal(${suc.id_sucursal}, ${activa})" 
                                class="text-orange-600 hover:text-orange-800 text-lg" title="Cambiar estado">
                            <i class="fas fa-toggle-${activa ? 'on' : 'off'}"></i>
                        </button>
                        <button onclick="eliminarSucursal(${suc.id_sucursal})" 
                                class="text-red-600 hover:text-red-800 text-lg" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function renderizarPromosPorSucursal() {
            const tbody = document.getElementById('tablaSucursalesPromos');
            const sucursalesActivas = sucursales.filter(s => s.activa !== false);
            tbody.innerHTML = sucursalesActivas.map(suc => {
                const promosEnSucursal = relaciones.filter(r => r.id_sucursal === suc.id_sucursal);
                const promosActivas = promosEnSucursal.filter(r => {
                    const promo = promociones.find(p => p.id_promocion === r.id_promocion);
                    return promo && promo.activa;
                }).length;

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${suc.nombre_sucursal}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${suc.ciudad || '-'}</td>
                        <td class="px-6 py-4 text-sm font-semibold text-blue-600">${promosEnSucursal.length}</td>
                        <td class="px-6 py-4 text-sm font-semibold text-green-600">${promosActivas}</td>
                    </tr>
                `;
            }).join('');
        }

        function llenarSelectSucursales() {
            const select = document.getElementById('filtroSucursal');
            if (select) {
                const valorActual = select.value;
                const sucursalesActivas = sucursales.filter(s => s.activa !== false);
                select.innerHTML = '<option value="">Todas las sucursales</option>' +
                    sucursalesActivas.map(s => `<option value="${s.id_sucursal}">${s.nombre_sucursal}</option>`).join('');
                select.value = valorActual;
            }
        }

        function llenarCheckboxesSucursales(sucursalesSeleccionadas = []) {
            const container = document.getElementById('checkboxesSucursales');
            const sucursalesActivas = sucursales.filter(s => s.activa !== false);
            container.innerHTML = sucursalesActivas.map(s => {
                const checked = sucursalesSeleccionadas.includes(s.id_sucursal) ? 'checked' : '';
                return `
                <label class="flex items-center space-x-3 cursor-pointer hover:bg-white p-3 rounded-lg transition group">
                    <input type="checkbox" name="sucursales" value="${s.id_sucursal}" ${checked}
                           class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer">
                    <div class="flex-1">
                        <span class="text-sm font-medium text-gray-900 group-hover:text-blue-600">${s.nombre_sucursal}</span>
                        <span class="text-xs text-gray-500 ml-2">${s.ciudad}</span>
                    </div>
                </label>
            `;
            }).join('');
        }

        function seleccionarTodasSucursales() {
            document.querySelectorAll('#checkboxesSucursales input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function deseleccionarTodasSucursales() {
            document.querySelectorAll('#checkboxesSucursales input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        function mostrarFormNuevaPromocion() {
            document.getElementById('tituloModalPromo').textContent = '‚ûï Nueva Promoci√≥n';
            document.getElementById('idPromocionEditar').value = '';
            document.getElementById('formPromocion').reset();
            llenarCheckboxesSucursales();
            document.getElementById('modalPromocion').classList.remove('hidden');
        }

        function cerrarModalPromocion() {
            document.getElementById('modalPromocion').classList.add('hidden');
            document.getElementById('formPromocion').reset();
        }

        function editarPromocion(idPromocion) {
            const promo = promociones.find(p => p.id_promocion === idPromocion);
            if (!promo) return;

            document.getElementById('tituloModalPromo').textContent = '‚úèÔ∏è Editar Promoci√≥n';
            document.getElementById('idPromocionEditar').value = promo.id_promocion;
            document.getElementById('descripcion').value = promo.descripcion;
            document.getElementById('precio').value = promo.precio;
            document.getElementById('activa').value = promo.activa.toString();
            document.getElementById('fechaInicio').value = promo.fecha_inicio || '';
            document.getElementById('fechaFin').value = promo.fecha_fin || '';

            const sucursalesAsignadas = relaciones.filter(r => r.id_promocion === idPromocion).map(r => r.id_sucursal);
            llenarCheckboxesSucursales(sucursalesAsignadas);

            document.getElementById('modalPromocion').classList.remove('hidden');
        }

        async function guardarPromocion(event) {
            event.preventDefault();

            const idEditar = document.getElementById('idPromocionEditar').value;
            const descripcion = document.getElementById('descripcion').value;
            const precio = parseFloat(document.getElementById('precio').value);
            const activa = document.getElementById('activa').value === 'true';
            const fechaInicio = document.getElementById('fechaInicio').value || null;
            const fechaFin = document.getElementById('fechaFin').value || null;
            const sucursalesSeleccionadas = Array.from(document.querySelectorAll('input[name="sucursales"]:checked')).map(cb => parseInt(cb.value));

            if (sucursalesSeleccionadas.length === 0) {
                mostrarToast('Selecciona al menos una sucursal', 'warning');
                return;
            }

            try {
                let idPromocion;

                if (idEditar) {
                    await fetch(`${SUPABASE_URL}/promociones?id_promocion=eq.${idEditar}`, {
                        method: 'PATCH',
                        headers,
                        body: JSON.stringify({ descripcion, precio, activa, fecha_inicio: fechaInicio, fecha_fin: fechaFin })
                    });
                    idPromocion = parseInt(idEditar);

                    await fetch(`${SUPABASE_URL}/sucursal_promocion?id_promocion=eq.${idPromocion}`, {
                        method: 'DELETE',
                        headers
                    });
                } else {
                    const responsePromo = await fetch(`${SUPABASE_URL}/promociones`, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({ descripcion, precio, activa, fecha_inicio: fechaInicio, fecha_fin: fechaFin })
                    });
                    const [nuevaPromo] = await responsePromo.json();
                    idPromocion = nuevaPromo.id_promocion;
                }

                const relacionesNuevas = sucursalesSeleccionadas.map(id_suc => ({
                    id_sucursal: id_suc,
                    id_promocion: idPromocion
                }));

                await fetch(`${SUPABASE_URL}/sucursal_promocion`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(relacionesNuevas)
                });

                mostrarToast(idEditar ? 'Promoci√≥n actualizada correctamente' : 'Promoci√≥n creada correctamente', 'success');
                cerrarModalPromocion();
                await cargarDatos();
            } catch (error) {
                console.error('Error:', error);
                mostrarToast('Error al guardar la promoci√≥n', 'error');
            }
        }

        async function toggleEstadoPromo(id, estadoActual) {
            try {
                await fetch(`${SUPABASE_URL}/promociones?id_promocion=eq.${id}`, {
                    method: 'PATCH',
                    headers,
                    body: JSON.stringify({ activa: !estadoActual })
                });
                await cargarDatos();
                mostrarToast(`Promoci√≥n ${!estadoActual ? 'activada' : 'desactivada'}`, 'success');
            } catch (error) {
                console.error('Error:', error);
                mostrarToast('Error al cambiar estado', 'error');
            }
        }

        async function eliminarPromo(id) {
            if (!confirm('‚ö†Ô∏è ¬øEliminar esta promoci√≥n?')) return;

            try {
                await fetch(`${SUPABASE_URL}/promociones?id_promocion=eq.${id}`, {
                    method: 'DELETE',
                    headers
                });
                mostrarToast('Promoci√≥n eliminada correctamente', 'success');
                await cargarDatos();
            } catch (error) {
                mostrarToast('Error al eliminar', 'error');
            }
        }

        function mostrarFormNuevaSucursal() {
            document.getElementById('tituloModalSucursal').textContent = '‚ûï Nueva Sucursal';
            document.getElementById('idSucursalEditar').value = '';
            document.getElementById('idSucursalManual').value = '';
            document.getElementById('idSucursalManual').disabled = false;
            document.getElementById('formSucursal').reset();
            document.getElementById('modalSucursal').classList.remove('hidden');
        }

        function cerrarModalSucursal() {
            document.getElementById('modalSucursal').classList.add('hidden');
            document.getElementById('formSucursal').reset();
        }

        function editarSucursal(idSucursal) {
            const suc = sucursales.find(s => s.id_sucursal === idSucursal);
            if (!suc) return;

            document.getElementById('tituloModalSucursal').textContent = '‚úèÔ∏è Editar Sucursal';
            document.getElementById('idSucursalEditar').value = suc.id_sucursal;
            document.getElementById('idSucursalManual').value = suc.id_sucursal;
            document.getElementById('idSucursalManual').disabled = true;
            document.getElementById('nombreSucursal').value = suc.nombre_sucursal;
            document.getElementById('ciudadSucursal').value = suc.ciudad || '';
            document.getElementById('direccionSucursal').value = suc.direccion || '';
            document.getElementById('telefonoSucursal').value = suc.telefono || '';
            document.getElementById('horariosSucursal').value = suc.horarios || '';
            document.getElementById('activaSucursal').value = (suc.activa !== false).toString();

            document.getElementById('modalSucursal').classList.remove('hidden');
        }

        async function guardarSucursal(event) {
            event.preventDefault();

            const idEditar = document.getElementById('idSucursalEditar').value;
            const idSucursal = parseInt(document.getElementById('idSucursalManual').value);
            const datos = {
                nombre_sucursal: document.getElementById('nombreSucursal').value,
                ciudad: document.getElementById('ciudadSucursal').value,
                direccion: document.getElementById('direccionSucursal').value,
                telefono: document.getElementById('telefonoSucursal').value,
                horarios: document.getElementById('horariosSucursal').value || null,
                activa: document.getElementById('activaSucursal').value === 'true'
            };

            try {
                if (idEditar) {
                    await fetch(`${SUPABASE_URL}/sucursales?id_sucursal=eq.${idEditar}`, {
                        method: 'PATCH',
                        headers,
                        body: JSON.stringify(datos)
                    });
                    mostrarToast('Sucursal actualizada correctamente', 'success');
                } else {
                    const existe = sucursales.find(s => s.id_sucursal === idSucursal);
                    if (existe) {
                        mostrarToast('Ya existe una sucursal con ese ID', 'error');
                        return;
                    }

                    await fetch(`${SUPABASE_URL}/sucursales`, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({ id_sucursal: idSucursal, ...datos })
                    });
                    mostrarToast('Sucursal creada correctamente', 'success');
                }

                cerrarModalSucursal();
                await cargarDatos();
            } catch (error) {
                console.error('Error:', error);
                mostrarToast('Error al guardar sucursal', 'error');
            }
        }

        async function toggleEstadoSucursal(id, estadoActual) {
            try {
                await fetch(`${SUPABASE_URL}/sucursales?id_sucursal=eq.${id}`, {
                    method: 'PATCH',
                    headers,
                    body: JSON.stringify({ activa: !estadoActual })
                });
                await cargarDatos();
                mostrarToast(`Sucursal ${!estadoActual ? 'activada' : 'desactivada'}`, 'success');
            } catch (error) {
                console.error('Error:', error);
                mostrarToast('Error al cambiar estado', 'error');
            }
        }

        async function eliminarSucursal(id) {
            if (!confirm('‚ö†Ô∏è ¬øEliminar esta sucursal?')) return;

            try {
                await fetch(`${SUPABASE_URL}/sucursales?id_sucursal=eq.${id}`, {
                    method: 'DELETE',
                    headers
                });
                mostrarToast('Sucursal eliminada correctamente', 'success');
                await cargarDatos();
            } catch (error) {
                mostrarToast('Error al eliminar', 'error');
            }
        }

        function filtrarPromociones() {
            aplicarFiltrosActuales();
            paginaActual = 1;
            renderizarTablaPromociones();
        }
    </script>
</body>
</html>

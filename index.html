<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Promociones DX-RAY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; }
        .section-hidden { display: none; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
            <div class="container mx-auto px-6 py-4">
                <h1 class="text-3xl font-bold">ü¶∑ Dashboard DX-RAY</h1>
                <p class="text-blue-100">Gesti√≥n de Promociones y Sucursales</p>
            </div>
        </header>

        <!-- Navegaci√≥n por pesta√±as -->
        <div class="bg-white shadow-md border-b">
            <div class="container mx-auto px-6">
                <nav class="flex gap-8">
                    <button onclick="cambiarSeccion('dashboard')" id="tab-dashboard" class="tab-active py-4 px-2 font-medium transition">
                        <i class="fas fa-chart-line mr-2"></i>Dashboard
                    </button>
                    <button onclick="cambiarSeccion('promociones')" id="tab-promociones" class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600 transition">
                        <i class="fas fa-tags mr-2"></i>Promociones
                    </button>
                    <button onclick="cambiarSeccion('sucursales')" id="tab-sucursales" class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600 transition">
                        <i class="fas fa-building mr-2"></i>Sucursales
                    </button>
                </nav>
            </div>
        </div>

        <div class="container mx-auto px-6 py-8">

            <!-- SECCI√ìN: DASHBOARD -->
            <div id="section-dashboard">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Total Promociones</p>
                                <p class="text-3xl font-bold text-gray-800" id="totalPromos">0</p>
                            </div>
                            <div class="bg-blue-100 rounded-full p-3">
                                <i class="fas fa-tags text-blue-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Promociones Activas</p>
                                <p class="text-3xl font-bold text-gray-800" id="promosActivas">0</p>
                            </div>
                            <div class="bg-green-100 rounded-full p-3">
                                <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-red-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Promociones Inactivas</p>
                                <p class="text-3xl font-bold text-gray-800" id="promosInactivas">0</p>
                            </div>
                            <div class="bg-red-100 rounded-full p-3">
                                <i class="fas fa-times-circle text-red-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-purple-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Sucursales</p>
                                <p class="text-3xl font-bold text-gray-800" id="totalSucursales">0</p>
                            </div>
                            <div class="bg-purple-100 rounded-full p-3">
                                <i class="fas fa-building text-purple-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Promociones por Sucursal -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üìä Promociones por Sucursal</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sucursal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ciudad</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Promos</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Activas</th>
                                </tr>
                            </thead>
                            <tbody id="tablaSucursalesPromos" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN: PROMOCIONES -->
            <div id="section-promociones" class="section-hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">üìã Gesti√≥n de Promociones</h3>
                        <button onclick="mostrarFormNuevaPromocion()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
                            <i class="fas fa-plus"></i>
                            Nueva Promoci√≥n
                        </button>
                    </div>

                    <!-- Filtros -->
                    <div class="mb-4 flex gap-4 flex-wrap">
                        <select id="filtroSucursal" onchange="filtrarPromociones()" class="border border-gray-300 rounded-lg px-4 py-2">
                            <option value="">Todas las sucursales</option>
                        </select>
                        <select id="filtroEstado" onchange="filtrarPromociones()" class="border border-gray-300 rounded-lg px-4 py-2">
                            <option value="">Todos los estados</option>
                            <option value="true">Activas</option>
                            <option value="false">Inactivas</option>
                        </select>
                        <input type="text" id="buscarPromo" placeholder="Buscar promoci√≥n..." onkeyup="filtrarPromociones()" class="border border-gray-300 rounded-lg px-4 py-2 flex-1 min-w-[200px]">
                    </div>

                    <!-- Selector de items por p√°gina -->
                    <div class="mb-4 flex items-center gap-2">
                        <label class="text-sm text-gray-600">Mostrar:</label>
                        <select id="itemsPorPagina" onchange="cambiarItemsPorPagina()" class="border border-gray-300 rounded px-3 py-1 text-sm">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span class="text-sm text-gray-600">registros</span>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descripci√≥n</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Precio</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sucursales</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaPromociones" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginaci√≥n -->
                    <div class="mt-4 flex justify-between items-center">
                        <div class="text-sm text-gray-600" id="infoPromos"></div>
                        <div class="flex gap-2" id="paginacionPromos"></div>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN: SUCURSALES -->
            <div id="section-sucursales" class="section-hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">üè• Gesti√≥n de Sucursales</h3>
                        <button onclick="mostrarFormNuevaSucursal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
                            <i class="fas fa-plus"></i>
                            Nueva Sucursal
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ciudad</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tel√©fono</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Promociones</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaSucursales" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal Nueva/Editar Promoci√≥n -->
    <div id="modalPromocion" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800" id="tituloModalPromo">‚ûï Nueva Promoci√≥n</h3>
                <button onclick="cerrarModalPromocion()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="formPromocion" onsubmit="guardarPromocion(event)">
                <input type="hidden" id="idPromocionEditar">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n</label>
                        <textarea id="descripcion" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Precio</label>
                        <input type="number" id="precio" step="0.01" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                        <select id="activa" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="true">Activa</option>
                            <option value="false">Inactiva</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Asignar a Sucursales</label>
                        <div class="flex gap-2 mb-2">
                            <button type="button" onclick="seleccionarTodasSucursales()" class="text-sm text-blue-600 hover:text-blue-800">
                                <i class="fas fa-check-square"></i> Seleccionar todas
                            </button>
                            <button type="button" onclick="deseleccionarTodasSucursales()" class="text-sm text-gray-600 hover:text-gray-800">
                                <i class="fas fa-square"></i> Deseleccionar todas
                            </button>
                        </div>
                        <div id="checkboxesSucursales" class="space-y-2 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-4 bg-gray-50">
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                    <button type="button" onclick="cerrarModalPromocion()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-medium transition">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Nueva/Editar Sucursal -->
    <div id="modalSucursal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800" id="tituloModalSucursal">‚ûï Nueva Sucursal</h3>
                <button onclick="cerrarModalSucursal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="formSucursal" onsubmit="guardarSucursal(event)">
                <input type="hidden" id="idSucursalEditar">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de la Sucursal</label>
                        <input type="text" id="nombreSucursal" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ciudad</label>
                        <input type="text" id="ciudadSucursal" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Direcci√≥n</label>
                        <textarea id="direccionSucursal" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500" rows="2"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tel√©fono</label>
                        <input type="text" id="telefonoSucursal" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Horarios</label>
                        <input type="text" id="horariosSucursal" placeholder="Ej: Lunes a Viernes 10:00 - 19:00" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                    <button type="button" onclick="cerrarModalSucursal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-medium transition">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Credenciales configuradas
        const SUPABASE_URL = 'https://sdqmuabsdsghptbttwiy.supabase.co/rest/v1';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkcW11YWJzZHNnaHB0YnR0d2l5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MTQ2NjMsImV4cCI6MjA4NTk5MDY2M30.Ki1AazQ5A7QcQuA0wUOjujGAGn1k749VRK2qoD7vNR0';

        const headers = {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
        };

        let promociones = [];
        let sucursales = [];
        let relaciones = [];
        let promocionesFiltradas = [];
        let paginaActual = 1;
        let itemsPorPagina = 10;

        document.addEventListener('DOMContentLoaded', () => {
            cargarDatos();
        });

        async function cargarDatos() {
            try {
                await Promise.all([
                    cargarSucursales(),
                    cargarPromociones(),
                    cargarRelaciones()
                ]);
                actualizarUI();
            } catch (error) {
                console.error('Error cargando datos:', error);
                alert('Error al cargar los datos. Revisa la consola.');
            }
        }

        async function cargarSucursales() {
            const response = await fetch(`${SUPABASE_URL}/sucursales?select=*`, { headers });
            sucursales = await response.json();
            llenarSelectSucursales();
            llenarCheckboxesSucursales();
        }

        async function cargarPromociones() {
            const response = await fetch(`${SUPABASE_URL}/promociones?select=*`, { headers });
            promociones = await response.json();
            promocionesFiltradas = [...promociones];
        }

        async function cargarRelaciones() {
            const response = await fetch(`${SUPABASE_URL}/sucursal_promocion?select=*`, { headers });
            relaciones = await response.json();
        }

        function actualizarUI() {
            actualizarStats();
            renderizarTablaPromociones();
            renderizarTablaSucursales();
            renderizarPromosPorSucursal();
        }

        function actualizarStats() {
            document.getElementById('totalPromos').textContent = promociones.length;
            document.getElementById('promosActivas').textContent = promociones.filter(p => p.activa).length;
            document.getElementById('promosInactivas').textContent = promociones.filter(p => !p.activa).length;
            document.getElementById('totalSucursales').textContent = sucursales.length;
        }

        function cambiarSeccion(seccion) {
            // Ocultar todas las secciones
            document.getElementById('section-dashboard').classList.add('section-hidden');
            document.getElementById('section-promociones').classList.add('section-hidden');
            document.getElementById('section-sucursales').classList.add('section-hidden');

            // Remover clase activa de todos los tabs
            document.getElementById('tab-dashboard').classList.remove('tab-active');
            document.getElementById('tab-promociones').classList.remove('tab-active');
            document.getElementById('tab-sucursales').classList.remove('tab-active');

            // Mostrar secci√≥n seleccionada
            document.getElementById(`section-${seccion}`).classList.remove('section-hidden');
            document.getElementById(`tab-${seccion}`).classList.add('tab-active');
        }

        function cambiarItemsPorPagina() {
            itemsPorPagina = parseInt(document.getElementById('itemsPorPagina').value);
            paginaActual = 1;
            renderizarTablaPromociones();
        }

        function renderizarTablaPromociones() {
            const tbody = document.getElementById('tablaPromociones');
            if (promocionesFiltradas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No hay promociones</td></tr>';
                document.getElementById('infoPromos').textContent = '';
                document.getElementById('paginacionPromos').innerHTML = '';
                return;
            }

            // Calcular paginaci√≥n
            const totalPaginas = Math.ceil(promocionesFiltradas.length / itemsPorPagina);
            const inicio = (paginaActual - 1) * itemsPorPagina;
            const fin = inicio + itemsPorPagina;
            const promosPagina = promocionesFiltradas.slice(inicio, fin);

            tbody.innerHTML = promosPagina.map(promo => {
                const sucursalesAsignadas = relaciones.filter(r => r.id_promocion === promo.id_promocion);

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm text-gray-900">${promo.descripcion.substring(0, 60)}${promo.descripcion.length > 60 ? '...' : ''}</td>
                        <td class="px-6 py-4 text-sm font-semibold text-green-600">$${Number(promo.precio).toFixed(2)}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full ${promo.activa ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${promo.activa ? '‚úì Activa' : '‚úó Inactiva'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm font-semibold text-blue-600">${sucursalesAsignadas.length}</td>
                        <td class="px-6 py-4 flex gap-2">
                            <button onclick="editarPromocion(${promo.id_promocion})" 
                                    class="text-blue-600 hover:text-blue-800 text-lg" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="toggleEstadoPromo(${promo.id_promocion}, ${promo.activa})" 
                                    class="text-orange-600 hover:text-orange-800 text-lg" title="Cambiar estado">
                                <i class="fas fa-toggle-${promo.activa ? 'on' : 'off'}"></i>
                            </button>
                            <button onclick="eliminarPromo(${promo.id_promocion})" 
                                    class="text-red-600 hover:text-red-800 text-lg" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Info de paginaci√≥n
            document.getElementById('infoPromos').textContent = `Mostrando ${inicio + 1} - ${Math.min(fin, promocionesFiltradas.length)} de ${promocionesFiltradas.length} promociones`;

            // Botones de paginaci√≥n
            let paginacionHTML = '';
            if (paginaActual > 1) {
                paginacionHTML += `<button onclick="cambiarPagina(${paginaActual - 1})" class="px-3 py-1 border rounded hover:bg-gray-100">Anterior</button>`;
            }
            for (let i = 1; i <= totalPaginas; i++) {
                if (i === paginaActual) {
                    paginacionHTML += `<button class="px-3 py-1 border rounded bg-blue-600 text-white">${i}</button>`;
                } else if (Math.abs(i - paginaActual) <= 2 || i === 1 || i === totalPaginas) {
                    paginacionHTML += `<button onclick="cambiarPagina(${i})" class="px-3 py-1 border rounded hover:bg-gray-100">${i}</button>`;
                } else if (Math.abs(i - paginaActual) === 3) {
                    paginacionHTML += `<span class="px-2">...</span>`;
                }
            }
            if (paginaActual < totalPaginas) {
                paginacionHTML += `<button onclick="cambiarPagina(${paginaActual + 1})" class="px-3 py-1 border rounded hover:bg-gray-100">Siguiente</button>`;
            }
            document.getElementById('paginacionPromos').innerHTML = paginacionHTML;
        }

        function cambiarPagina(pagina) {
            paginaActual = pagina;
            renderizarTablaPromociones();
        }

        function renderizarTablaSucursales() {
            const tbody = document.getElementById('tablaSucursales');
            tbody.innerHTML = sucursales.map(suc => {
                const cantPromos = relaciones.filter(r => r.id_sucursal === suc.id_sucursal).length;
                return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${suc.nombre_sucursal}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${suc.ciudad || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${suc.telefono || '-'}</td>
                    <td class="px-6 py-4 text-sm font-semibold text-blue-600">${cantPromos}</td>
                    <td class="px-6 py-4 flex gap-2">
                        <button onclick="editarSucursal(${suc.id_sucursal})" 
                                class="text-blue-600 hover:text-blue-800 text-lg" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="eliminarSucursal(${suc.id_sucursal})" 
                                class="text-red-600 hover:text-red-800 text-lg" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function renderizarPromosPorSucursal() {
            const tbody = document.getElementById('tablaSucursalesPromos');
            tbody.innerHTML = sucursales.map(suc => {
                const promosEnSucursal = relaciones.filter(r => r.id_sucursal === suc.id_sucursal);
                const promosActivas = promosEnSucursal.filter(r => {
                    const promo = promociones.find(p => p.id_promocion === r.id_promocion);
                    return promo && promo.activa;
                }).length;

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${suc.nombre_sucursal}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${suc.ciudad || '-'}</td>
                        <td class="px-6 py-4 text-sm font-semibold text-blue-600">${promosEnSucursal.length}</td>
                        <td class="px-6 py-4 text-sm font-semibold text-green-600">${promosActivas}</td>
                    </tr>
                `;
            }).join('');
        }

        function llenarSelectSucursales() {
            const select = document.getElementById('filtroSucursal');
            select.innerHTML = '<option value="">Todas las sucursales</option>' +
                sucursales.map(s => `<option value="${s.id_sucursal}">${s.nombre_sucursal}</option>`).join('');
        }

        function llenarCheckboxesSucursales(sucursalesSeleccionadas = []) {
            const container = document.getElementById('checkboxesSucursales');
            container.innerHTML = sucursales.map(s => {
                const checked = sucursalesSeleccionadas.includes(s.id_sucursal) ? 'checked' : '';
                return `
                <label class="flex items-center space-x-3 cursor-pointer hover:bg-white p-3 rounded-lg transition group">
                    <input type="checkbox" name="sucursales" value="${s.id_sucursal}" ${checked}
                           class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer">
                    <div class="flex-1">
                        <span class="text-sm font-medium text-gray-900 group-hover:text-blue-600">${s.nombre_sucursal}</span>
                        <span class="text-xs text-gray-500 ml-2">${s.ciudad}</span>
                    </div>
                </label>
            `;
            }).join('');
        }

        function seleccionarTodasSucursales() {
            document.querySelectorAll('#checkboxesSucursales input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function deseleccionarTodasSucursales() {
            document.querySelectorAll('#checkboxesSucursales input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        function mostrarFormNuevaPromocion() {
            document.getElementById('tituloModalPromo').textContent = '‚ûï Nueva Promoci√≥n';
            document.getElementById('idPromocionEditar').value = '';
            document.getElementById('formPromocion').reset();
            llenarCheckboxesSucursales();
            document.getElementById('modalPromocion').classList.remove('hidden');
        }

        function cerrarModalPromocion() {
            document.getElementById('modalPromocion').classList.add('hidden');
            document.getElementById('formPromocion').reset();
        }

        function editarPromocion(idPromocion) {
            const promo = promociones.find(p => p.id_promocion === idPromocion);
            if (!promo) return;

            document.getElementById('tituloModalPromo').textContent = '‚úèÔ∏è Editar Promoci√≥n';
            document.getElementById('idPromocionEditar').value = promo.id_promocion;
            document.getElementById('descripcion').value = promo.descripcion;
            document.getElementById('precio').value = promo.precio;
            document.getElementById('activa').value = promo.activa.toString();

            const sucursalesAsignadas = relaciones.filter(r => r.id_promocion === idPromocion).map(r => r.id_sucursal);
            llenarCheckboxesSucursales(sucursalesAsignadas);

            document.getElementById('modalPromocion').classList.remove('hidden');
        }

        async function guardarPromocion(event) {
            event.preventDefault();

            const idEditar = document.getElementById('idPromocionEditar').value;
            const descripcion = document.getElementById('descripcion').value;
            const precio = parseFloat(document.getElementById('precio').value);
            const activa = document.getElementById('activa').value === 'true';
            const sucursalesSeleccionadas = Array.from(document.querySelectorAll('input[name="sucursales"]:checked')).map(cb => parseInt(cb.value));

            if (sucursalesSeleccionadas.length === 0) {
                alert('‚ö†Ô∏è Selecciona al menos una sucursal');
                return;
            }

            try {
                let idPromocion;

                if (idEditar) {
                    // EDITAR promoci√≥n existente
                    await fetch(`${SUPABASE_URL}/promociones?id_promocion=eq.${idEditar}`, {
                        method: 'PATCH',
                        headers,
                        body: JSON.stringify({ descripcion, precio, activa })
                    });
                    idPromocion = parseInt(idEditar);

                    // Eliminar relaciones anteriores
                    await fetch(`${SUPABASE_URL}/sucursal_promocion?id_promocion=eq.${idPromocion}`, {
                        method: 'DELETE',
                        headers
                    });
                } else {
                    // CREAR nueva promoci√≥n
                    const responsePromo = await fetch(`${SUPABASE_URL}/promociones`, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({ descripcion, precio, activa })
                    });
                    const [nuevaPromo] = await responsePromo.json();
                    idPromocion = nuevaPromo.id_promocion;
                }

                // Crear las relaciones
                const relacionesNuevas = sucursalesSeleccionadas.map(id_suc => ({
                    id_sucursal: id_suc,
                    id_promocion: idPromocion
                }));

                await fetch(`${SUPABASE_URL}/sucursal_promocion`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(relacionesNuevas)
                });

                alert(idEditar ? '‚úÖ Promoci√≥n actualizada' : '‚úÖ Promoci√≥n creada');
                cerrarModalPromocion();
                await cargarDatos();
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al guardar la promoci√≥n');
            }
        }

        async function toggleEstadoPromo(id, estadoActual) {
            try {
                await fetch(`${SUPABASE_URL}/promociones?id_promocion=eq.${id}`, {
                    method: 'PATCH',
                    headers,
                    body: JSON.stringify({ activa: !estadoActual })
                });
                await cargarDatos();
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al cambiar estado');
            }
        }

        async function eliminarPromo(id) {
            if (!confirm('‚ö†Ô∏è ¬øEliminar esta promoci√≥n?')) return;

            try {
                await fetch(`${SUPABASE_URL}/promociones?id_promocion=eq.${id}`, {
                    method: 'DELETE',
                    headers
                });
                alert('‚úÖ Promoci√≥n eliminada');
                await cargarDatos();
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al eliminar');
            }
        }

        // CRUD SUCURSALES
        function mostrarFormNuevaSucursal() {
            document.getElementById('tituloModalSucursal').textContent = '‚ûï Nueva Sucursal';
            document.getElementById('idSucursalEditar').value = '';
            document.getElementById('formSucursal').reset();
            document.getElementById('modalSucursal').classList.remove('hidden');
        }

        function cerrarModalSucursal() {
            document.getElementById('modalSucursal').classList.add('hidden');
            document.getElementById('formSucursal').reset();
        }

        function editarSucursal(idSucursal) {
            const suc = sucursales.find(s => s.id_sucursal === idSucursal);
            if (!suc) return;

            document.getElementById('tituloModalSucursal').textContent = '‚úèÔ∏è Editar Sucursal';
            document.getElementById('idSucursalEditar').value = suc.id_sucursal;
            document.getElementById('nombreSucursal').value = suc.nombre_sucursal;
            document.getElementById('ciudadSucursal').value = suc.ciudad || '';
            document.getElementById('direccionSucursal').value = suc.direccion || '';
            document.getElementById('telefonoSucursal').value = suc.telefono || '';
            document.getElementById('horariosSucursal').value = suc.horarios || '';

            document.getElementById('modalSucursal').classList.remove('hidden');
        }

        async function guardarSucursal(event) {
            event.preventDefault();

            const idEditar = document.getElementById('idSucursalEditar').value;
            const datos = {
                nombre_sucursal: document.getElementById('nombreSucursal').value,
                ciudad: document.getElementById('ciudadSucursal').value,
                direccion: document.getElementById('direccionSucursal').value,
                telefono: document.getElementById('telefonoSucursal').value,
                horarios: document.getElementById('horariosSucursal').value
            };

            try {
                if (idEditar) {
                    await fetch(`${SUPABASE_URL}/sucursales?id_sucursal=eq.${idEditar}`, {
                        method: 'PATCH',
                        headers,
                        body: JSON.stringify(datos)
                    });
                    alert('‚úÖ Sucursal actualizada');
                } else {
                    await fetch(`${SUPABASE_URL}/sucursales`, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify(datos)
                    });
                    alert('‚úÖ Sucursal creada');
                }

                cerrarModalSucursal();
                await cargarDatos();
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al guardar sucursal');
            }
        }

        async function eliminarSucursal(id) {
            if (!confirm('‚ö†Ô∏è ¬øEliminar esta sucursal? Se eliminar√°n sus relaciones con promociones.')) return;

            try {
                await fetch(`${SUPABASE_URL}/sucursales?id_sucursal=eq.${id}`, {
                    method: 'DELETE',
                    headers
                });
                alert('‚úÖ Sucursal eliminada');
                await cargarDatos();
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al eliminar');
            }
        }

        function filtrarPromociones() {
            const sucursalId = document.getElementById('filtroSucursal').value;
            const estado = document.getElementById('filtroEstado').value;
            const busqueda = document.getElementById('buscarPromo').value.toLowerCase();

            promocionesFiltradas = promociones.filter(promo => {
                if (sucursalId) {
                    const tieneRelacion = relaciones.some(r => 
                        r.id_promocion === promo.id_promocion && 
                        r.id_sucursal == sucursalId
                    );
                    if (!tieneRelacion) return false;
                }

                if (estado !== '') {
                    if (promo.activa.toString() !== estado) return false;
                }

                if (busqueda) {
                    if (!promo.descripcion.toLowerCase().includes(busqueda)) return false;
                }

                return true;
            });

            paginaActual = 1;
            renderizarTablaPromociones();
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Promociones DX-RAY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
            <div class="container mx-auto px-6 py-4">
                <h1 class="text-3xl font-bold">ü¶∑ Dashboard DX-RAY</h1>
                <p class="text-blue-100">Gesti√≥n de Promociones y Sucursales</p>
            </div>
        </header>

        <div class="container mx-auto px-6 py-8">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Total Promociones</p>
                            <p class="text-3xl font-bold text-gray-800" id="totalPromos">0</p>
                        </div>
                        <div class="bg-blue-100 rounded-full p-3">
                            <i class="fas fa-tags text-blue-600 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Promociones Activas</p>
                            <p class="text-3xl font-bold text-gray-800" id="promosActivas">0</p>
                        </div>
                        <div class="bg-green-100 rounded-full p-3">
                            <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-red-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Promociones Inactivas</p>
                            <p class="text-3xl font-bold text-gray-800" id="promosInactivas">0</p>
                        </div>
                        <div class="bg-red-100 rounded-full p-3">
                            <i class="fas fa-times-circle text-red-600 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-purple-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Sucursales</p>
                            <p class="text-3xl font-bold text-gray-800" id="totalSucursales">0</p>
                        </div>
                        <div class="bg-purple-100 rounded-full p-3">
                            <i class="fas fa-building text-purple-600 text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Promociones por Sucursal -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">üìä Promociones por Sucursal</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sucursal</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ciudad</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Promos</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Activas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaSucursalesPromos" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-center text-gray-500">Cargando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Gesti√≥n de Promociones -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">üìã Gesti√≥n de Promociones</h3>
                    <button onclick="mostrarFormNuevaPromocion()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
                        <i class="fas fa-plus"></i>
                        Nueva Promoci√≥n
                    </button>
                </div>

                <!-- Filtros -->
                <div class="mb-4 flex gap-4">
                    <select id="filtroSucursal" onchange="filtrarPromociones()" class="border border-gray-300 rounded-lg px-4 py-2">
                        <option value="">Todas las sucursales</option>
                    </select>
                    <select id="filtroEstado" onchange="filtrarPromociones()" class="border border-gray-300 rounded-lg px-4 py-2">
                        <option value="">Todos los estados</option>
                        <option value="true">Activas</option>
                        <option value="false">Inactivas</option>
                    </select>
                    <input type="text" id="buscarPromo" placeholder="Buscar promoci√≥n..." onkeyup="filtrarPromociones()" class="border border-gray-300 rounded-lg px-4 py-2 flex-1">
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descripci√≥n</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Precio</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sucursales</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaPromociones" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-center text-gray-500">Cargando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Gesti√≥n de Sucursales -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">üè• Sucursales Registradas</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ciudad</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tel√©fono</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Horarios</th>
                            </tr>
                        </thead>
                        <tbody id="tablaSucursales" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-gray-500">Cargando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Promoci√≥n -->
    <div id="modalNuevaPromo" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">‚ûï Nueva Promoci√≥n</h3>
                <button onclick="cerrarModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="formNuevaPromo" onsubmit="guardarPromocion(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n</label>
                        <textarea id="descripcion" required class="w-full border border-gray-300 rounded-lg px-4 py-2" rows="3"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Precio</label>
                        <input type="number" id="precio" step="0.01" required class="w-full border border-gray-300 rounded-lg px-4 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                        <select id="activa" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                            <option value="true">Activa</option>
                            <option value="false">Inactiva</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Asignar a Sucursales</label>
                        <div id="checkboxesSucursales" class="space-y-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4">
                            <!-- Se llenan din√°micamente -->
                        </div>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition">
                        Guardar Promoci√≥n
                    </button>
                    <button type="button" onclick="cerrarModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-medium transition">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // CONFIGURA TUS CREDENCIALES AQU√ç
        const SUPABASE_URL = 'https://sdqmuabsdsghptbttwiy.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_M9qOYxTMgOKb9sOiLFZvZQ_MyiGwqjh';

        const headers = {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + SUPABASE_KEY,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
        };

        let promociones = [];
        let sucursales = [];
        let relaciones = [];

        document.addEventListener('DOMContentLoaded', () => {
            cargarDatos();
        });

        async function cargarDatos() {
            try {
                await Promise.all([
                    cargarSucursales(),
                    cargarPromociones(),
                    cargarRelaciones()
                ]);
                actualizarUI();
            } catch (error) {
                console.error('Error cargando datos:', error);
                alert('Error al cargar los datos. Revisa la consola.');
            }
        }

        async function cargarSucursales() {
            const response = await fetch(`${SUPABASE_URL}/sucursales?select=*`, { headers });
            sucursales = await response.json();
            llenarSelectSucursales();
            llenarCheckboxesSucursales();
        }

        async function cargarPromociones() {
            const response = await fetch(`${SUPABASE_URL}/promociones?select=*`, { headers });
            promociones = await response.json();
        }

        async function cargarRelaciones() {
            const response = await fetch(`${SUPABASE_URL}/sucursal_promocion?select=*`, { headers });
            relaciones = await response.json();
        }

        function actualizarUI() {
            actualizarStats();
            renderizarTablaPromociones();
            renderizarTablaSucursales();
            renderizarPromosPorSucursal();
        }

        function actualizarStats() {
            document.getElementById('totalPromos').textContent = promociones.length;
            document.getElementById('promosActivas').textContent = promociones.filter(p => p.activa).length;
            document.getElementById('promosInactivas').textContent = promociones.filter(p => !p.activa).length;
            document.getElementById('totalSucursales').textContent = sucursales.length;
        }

        function renderizarTablaPromociones() {
            const tbody = document.getElementById('tablaPromociones');
            if (promociones.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No hay promociones registradas</td></tr>';
                return;
            }

            tbody.innerHTML = promociones.map(promo => {
                const sucursalesAsignadas = relaciones.filter(r => r.id_promocion === promo.id_promocion);
                const nombresSucursales = sucursalesAsignadas.map(r => {
                    const suc = sucursales.find(s => s.id_sucursal === r.id_sucursal);
                    return suc ? suc.nombre_sucursal : '';
                }).filter(n => n).join(', ');

                return `
                    <tr>
                        <td class="px-6 py-4 text-sm text-gray-900">${promo.descripcion.substring(0, 80)}...</td>
                        <td class="px-6 py-4 text-sm font-semibold text-green-600">$${promo.precio.toFixed(2)}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full ${promo.activa ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${promo.activa ? 'Activa' : 'Inactiva'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">${sucursalesAsignadas.length} sucursales</td>
                        <td class="px-6 py-4">
                            <button onclick="toggleEstadoPromo(${promo.id_promocion}, ${promo.activa})" 
                                    class="text-blue-600 hover:text-blue-800 mr-3">
                                <i class="fas fa-toggle-${promo.activa ? 'on' : 'off'}"></i>
                            </button>
                            <button onclick="eliminarPromo(${promo.id_promocion})" 
                                    class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderizarTablaSucursales() {
            const tbody = document.getElementById('tablaSucursales');
            tbody.innerHTML = sucursales.map(suc => `
                <tr>
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${suc.nombre_sucursal}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${suc.ciudad || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${suc.telefono || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${suc.horarios || '-'}</td>
                </tr>
            `).join('');
        }

        function renderizarPromosPorSucursal() {
            const tbody = document.getElementById('tablaSucursalesPromos');
            tbody.innerHTML = sucursales.map(suc => {
                const promosEnSucursal = relaciones.filter(r => r.id_sucursal === suc.id_sucursal);
                const promosActivas = promosEnSucursal.filter(r => {
                    const promo = promociones.find(p => p.id_promocion === r.id_promocion);
                    return promo && promo.activa;
                }).length;

                return `
                    <tr>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${suc.nombre_sucursal}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${suc.ciudad || '-'}</td>
                        <td class="px-6 py-4 text-sm font-semibold text-blue-600">${promosEnSucursal.length}</td>
                        <td class="px-6 py-4 text-sm font-semibold text-green-600">${promosActivas}</td>
                        <td class="px-6 py-4">
                            <button onclick="verPromosSucursal(${suc.id_sucursal})" 
                                    class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function llenarSelectSucursales() {
            const select = document.getElementById('filtroSucursal');
            select.innerHTML = '<option value="">Todas las sucursales</option>' +
                sucursales.map(s => `<option value="${s.id_sucursal}">${s.nombre_sucursal}</option>`).join('');
        }

        function llenarCheckboxesSucursales() {
            const container = document.getElementById('checkboxesSucursales');
            container.innerHTML = sucursales.map(s => `
                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                    <input type="checkbox" name="sucursales" value="${s.id_sucursal}" class="form-checkbox h-4 w-4 text-blue-600">
                    <span class="text-sm">${s.nombre_sucursal} - ${s.ciudad}</span>
                </label>
            `).join('');
        }

        function mostrarFormNuevaPromocion() {
            document.getElementById('modalNuevaPromo').classList.remove('hidden');
        }

        function cerrarModal() {
            document.getElementById('modalNuevaPromo').classList.add('hidden');
            document.getElementById('formNuevaPromo').reset();
        }

        async function guardarPromocion(event) {
            event.preventDefault();

            const descripcion = document.getElementById('descripcion').value;
            const precio = parseFloat(document.getElementById('precio').value);
            const activa = document.getElementById('activa').value === 'true';
            const sucursalesSeleccionadas = Array.from(document.querySelectorAll('input[name="sucursales"]:checked')).map(cb => parseInt(cb.value));

            if (sucursalesSeleccionadas.length === 0) {
                alert('Selecciona al menos una sucursal');
                return;
            }

            try {
                // 1. Crear la promoci√≥n
                const responsePromo = await fetch(`${SUPABASE_URL}/promociones`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ descripcion, precio, activa })
                });
                const [nuevaPromo] = await responsePromo.json();

                // 2. Crear las relaciones
                const relacionesNuevas = sucursalesSeleccionadas.map(id_suc => ({
                    id_sucursal: id_suc,
                    id_promocion: nuevaPromo.id_promocion
                }));

                await fetch(`${SUPABASE_URL}/sucursal_promocion`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(relacionesNuevas)
                });

                alert('‚úÖ Promoci√≥n creada exitosamente');
                cerrarModal();
                await cargarDatos();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar la promoci√≥n');
            }
        }

        async function toggleEstadoPromo(id, estadoActual) {
            try {
                await fetch(`${SUPABASE_URL}/promociones?id_promocion=eq.${id}`, {
                    method: 'PATCH',
                    headers,
                    body: JSON.stringify({ activa: !estadoActual })
                });
                await cargarDatos();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cambiar estado');
            }
        }

        async function eliminarPromo(id) {
            if (!confirm('¬øEliminar esta promoci√≥n? Se eliminar√°n tambi√©n sus asignaciones a sucursales.')) return;

            try {
                await fetch(`${SUPABASE_URL}/promociones?id_promocion=eq.${id}`, {
                    method: 'DELETE',
                    headers
                });
                await cargarDatos();
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar');
            }
        }

        function filtrarPromociones() {
            // Implementar filtrado (opcional)
            renderizarTablaPromociones();
        }

        function verPromosSucursal(idSucursal) {
            const suc = sucursales.find(s => s.id_sucursal === idSucursal);
            const promosIds = relaciones.filter(r => r.id_sucursal === idSucursal).map(r => r.id_promocion);
            const promosSucursal = promociones.filter(p => promosIds.includes(p.id_promocion));

            const lista = promosSucursal.map(p => `‚Ä¢ ${p.descripcion} - $${p.precio}`).join('\n');
            alert(`Promociones en ${suc.nombre_sucursal}:\n\n${lista}`);
        }
    </script>
</body>
</html>

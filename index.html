<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DX-RAY v6.0 SIMPLIFICADO</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶∑</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; }
        .section-hidden { display: none; }
        .toast {
            position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999; animation: slideIn 0.3s;
            display: flex; align-items: center; gap: 12px; min-width: 300px;
        }
        .toast-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .toast-error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .toast-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.hiding { animation: slideOut 0.3s forwards; }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }
        .sync-progress {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 30px; border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 10000; min-width: 450px; max-height: 80vh; overflow-y: auto;
        }
        .progress-bar { width: 100%; height: 20px; background: #e5e7eb; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #2563eb); transition: width 0.3s; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">ü¶∑ DX-RAY v6.0</h1>
                    <p class="text-blue-100">Sistema Simplificado - Control Manual</p>
                </div>
                <button onclick="recargarDatos()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg flex items-center gap-2 transition">
                    <i class="fas fa-sync-alt" id="iconRecargar"></i>
                    Recargar
                </button>
            </div>
        </header>

        <div class="bg-white shadow-md border-b">
            <div class="container mx-auto px-6">
                <nav class="flex gap-6">
                    <button onclick="cambiarSeccion('dashboard')" id="tab-dashboard" class="tab-active py-4 px-2 font-medium transition">
                        <i class="fas fa-chart-line mr-2"></i>Dashboard
                    </button>
                    <button onclick="cambiarSeccion('plataformas')" id="tab-plataformas" class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600 transition">
                        <i class="fas fa-server mr-2"></i>Plataformas
                    </button>
                    <button onclick="cambiarSeccion('sucursales')" id="tab-sucursales" class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600 transition">
                        <i class="fas fa-building mr-2"></i>Sucursales
                    </button>
                    <button onclick="cambiarSeccion('prestaciones')" id="tab-prestaciones" class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600 transition">
                        <i class="fas fa-tags mr-2"></i>Prestaciones
                    </button>
                    <button onclick="cambiarSeccion('asignaciones')" id="tab-asignaciones" class="py-4 px-2 font-medium text-gray-600 hover:text-blue-600 transition">
                        <i class="fas fa-link mr-2"></i>Asignaciones
                    </button>
                </nav>
            </div>
        </div>

        <div class="container mx-auto px-6 py-8">

            <!-- DASHBOARD -->
            <div id="section-dashboard">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Prestaciones</p>
                                <p class="text-3xl font-bold text-gray-800" id="totalPrestaciones">0</p>
                            </div>
                            <div class="bg-blue-100 rounded-full p-3">
                                <i class="fas fa-tags text-blue-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Aranceles</p>
                                <p class="text-3xl font-bold text-gray-800" id="totalAranceles">0</p>
                            </div>
                            <div class="bg-green-100 rounded-full p-3">
                                <i class="fas fa-list-alt text-green-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-purple-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Sucursales</p>
                                <p class="text-3xl font-bold text-gray-800" id="totalSucursales">0</p>
                            </div>
                            <div class="bg-purple-100 rounded-full p-3">
                                <i class="fas fa-building text-purple-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-yellow-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm font-medium">Asignaciones</p>
                                <p class="text-3xl font-bold text-gray-800" id="totalAsignaciones">0</p>
                            </div>
                            <div class="bg-yellow-100 rounded-full p-3">
                                <i class="fas fa-link text-yellow-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üìä Resumen por Arancel</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Arancel</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Plataforma</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Categor√≠as</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Prestaciones</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sucursales Asignadas</th>
                                </tr>
                            </thead>
                            <tbody id="tablaResumen" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- PLATAFORMAS -->
            <div id="section-plataformas" class="section-hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">üåê Plataformas / Tokens</h3>
                        <button onclick="mostrarModalPlataforma()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
                            <i class="fas fa-plus"></i>
                            Nueva Plataforma
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Zona</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Token</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaPlataformas" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SUCURSALES -->
            <div id="section-sucursales" class="section-hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">üè• Sucursales</h3>
                        <button onclick="sincronizarSucursales()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
                            <i class="fas fa-sync" id="iconSyncSucursales"></i>
                            Sincronizar Dentalink
                        </button>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Plataforma:</label>
                        <select id="filtroPlataformaSucursales" onchange="filtrarSucursales()" class="border border-gray-300 rounded-lg px-4 py-2 w-full max-w-md">
                            <option value="">Todas las plataformas</option>
                        </select>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ciudad</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Plataforma</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aranceles Asignados</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                </tr>
                            </thead>
                            <tbody id="tablaSucursales" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- PRESTACIONES -->
            <div id="section-prestaciones" class="section-hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">üìã Prestaciones</h3>
                        <button onclick="sincronizarPrestaciones()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
                            <i class="fas fa-sync" id="iconSyncPrestaciones"></i>
                            Sincronizar Dentalink
                        </button>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>3 Niveles:</strong> Token ‚Üí Aranceles ‚Üí Categor√≠as ‚Üí Prestaciones (sin tocar sucursales)
                        </p>
                    </div>

                    <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <select id="filtroPlatPrest" onchange="filtrarPrestaciones()" class="border border-gray-300 rounded-lg px-4 py-2">
                            <option value="">Todas las plataformas</option>
                        </select>
                        <select id="filtroArancelPrest" onchange="filtrarPrestaciones()" class="border border-gray-300 rounded-lg px-4 py-2">
                            <option value="">Todos los aranceles</option>
                        </select>
                        <input type="text" id="buscarPrestacion" placeholder="Buscar..." onkeyup="filtrarPrestaciones()" class="border border-gray-300 rounded-lg px-4 py-2">
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Categor√≠a</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Precio</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Arancel</th>
                                </tr>
                            </thead>
                            <tbody id="tablaPrestaciones" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>

                    <div class="mt-4 flex justify-between items-center">
                        <div class="text-sm text-gray-600" id="infoPrestaciones"></div>
                        <div class="flex gap-2" id="paginacionPrestaciones"></div>
                    </div>
                </div>
            </div>

            <!-- ASIGNACIONES (NUEVA PESTA√ëA) -->
            <div id="section-asignaciones" class="section-hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">üîó Asignaciones Sucursal-Arancel</h3>
                        <button onclick="guardarAsignaciones()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
                            <i class="fas fa-save"></i>
                            Guardar Asignaciones
                        </button>
                    </div>

                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6">
                        <p class="text-sm text-yellow-800">
                            <i class="fas fa-hand-pointer mr-2"></i>
                            <strong>Instrucciones:</strong> Selecciona cada sucursal y marca a qu√© aranceles pertenece. Los aranceles pueden ser de diferentes plataformas.
                        </p>
                    </div>

                    <div id="contenedorAsignaciones" class="space-y-6"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modales -->
    <div id="modalPlataforma" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-lg w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800" id="tituloModalPlataforma">Nueva Plataforma</h3>
                <button onclick="cerrarModalPlataforma()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="formPlataforma" onsubmit="guardarPlataforma(event)">
                <input type="hidden" id="idPlataformaEditar">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Zona</label>
                        <input type="text" id="zonaPlataforma" required placeholder="Ej: Tuxtla" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Token Dentalink</label>
                        <textarea id="tokenPlataforma" required placeholder="Token API" class="w-full border border-gray-300 rounded-lg px-4 py-2" rows="3"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                        <select id="activaPlataforma" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                            <option value="true">Activa</option>
                            <option value="false">Inactiva</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                    <button type="button" onclick="cerrarModalPlataforma()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-medium">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="syncProgress" class="hidden">
        <div class="fixed inset-0 bg-black bg-opacity-50 z-50"></div>
        <div class="sync-progress">
            <h3 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-sync fa-spin text-blue-600 mr-2"></i>
                Sincronizando...
            </h3>
            <div class="progress-bar">
                <div id="syncProgressFill" class="progress-fill" style="width: 0%"></div>
            </div>
            <p class="text-sm text-gray-600 mt-2" id="syncProgressText">Iniciando...</p>
            <div class="mt-4 space-y-2" id="syncProgressDetails"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://sdqmuabsdsghptbttwiy.supabase.co/rest/v1';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkcW11YWJzZHNnaHB0YnR0d2l5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MTQ2NjMsImV4cCI6MjA4NTk5MDY2M30.Ki1AazQ5A7QcQuA0wUOjujGAGn1k749VRK2qoD7vNR0';
        const DENTALINK_API = 'https://api.dentalink.healthatom.com/api/v1';
        const headers = {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
        };

        let plataformas = [], aranceles = [], categorias = [], prestaciones = [], sucursales = [], arancelSucursal = [];
        let prestacionesFiltradas = [], paginaActual = 1, itemsPorPagina = 20;
        let asignacionesPendientes = {}; // Para guardar cambios temporales

        document.addEventListener('DOMContentLoaded', cargarDatos);

        function mostrarToast(mensaje, tipo = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${tipo}`;
            const iconos = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle' };
            toast.innerHTML = `<i class="fas ${iconos[tipo]} text-2xl"></i><span class="font-medium">${mensaje}</span>`;
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.add('hiding'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function mostrarProgreso(texto, porcentaje = 0, detalles = '') {
            document.getElementById('syncProgress').classList.remove('hidden');
            document.getElementById('syncProgressText').textContent = texto;
            document.getElementById('syncProgressFill').style.width = porcentaje + '%';
            if (detalles) {
                const detailItem = document.createElement('div');
                detailItem.className = 'text-xs text-gray-600';
                detailItem.innerHTML = `<i class="fas fa-check text-green-600 mr-2"></i>${detalles}`;
                document.getElementById('syncProgressDetails').appendChild(detailItem);
            }
        }

        function ocultarProgreso() {
            document.getElementById('syncProgress').classList.add('hidden');
            document.getElementById('syncProgressDetails').innerHTML = '';
        }

        async function recargarDatos() {
            const icon = document.getElementById('iconRecargar');
            icon.classList.add('fa-spin');
            await cargarDatos();
            setTimeout(() => { icon.classList.remove('fa-spin'); mostrarToast('Datos actualizados'); }, 500);
        }

        async function cargarDatos() {
            try {
                await Promise.all([
                    cargarPlataformas(),
                    cargarAranceles(),
                    cargarCategorias(),
                    cargarPrestaciones(),
                    cargarSucursales(),
                    cargarArancelSucursal()
                ]);
                actualizarUI();
            } catch (error) {
                console.error('Error:', error);
                mostrarToast('Error al cargar datos', 'error');
            }
        }

        async function cargarPlataformas() {
            const res = await fetch(`${SUPABASE_URL}/plataformas?select=*&order=id_plataforma.asc`, { headers });
            plataformas = await res.json();
            renderizarTablaPlataformas();
            llenarSelectsPlataforma();
        }

        async function cargarAranceles() {
            const res = await fetch(`${SUPABASE_URL}/aranceles?select=*&order=id_arancel_interno.asc`, { headers });
            aranceles = await res.json();
        }

        async function cargarCategorias() {
            const res = await fetch(`${SUPABASE_URL}/categorias?select=*&order=id_categoria_interno.asc`, { headers });
            categorias = await res.json();
        }

        async function cargarPrestaciones() {
            const res = await fetch(`${SUPABASE_URL}/prestaciones?select=*&order=id_prestacion_interno.asc`, { headers });
            prestaciones = await res.json();
            aplicarFiltrosPrestaciones();
        }

        async function cargarSucursales() {
            const res = await fetch(`${SUPABASE_URL}/sucursales?select=*&order=id_sucursal_interno.asc`, { headers });
            sucursales = await res.json();
            renderizarTablaSucursales();
        }

        async function cargarArancelSucursal() {
            const res = await fetch(`${SUPABASE_URL}/arancel_sucursal?select=*`, { headers });
            arancelSucursal = await res.json();
        }

        function actualizarUI() {
            document.getElementById('totalPrestaciones').textContent = prestaciones.length;
            document.getElementById('totalAranceles').textContent = aranceles.length;
            document.getElementById('totalSucursales').textContent = sucursales.length;
            document.getElementById('totalAsignaciones').textContent = arancelSucursal.length;
            renderizarResumen();
            renderizarTablaPrestaciones();
            renderizarAsignaciones();
        }

        function cambiarSeccion(seccion) {
            ['dashboard', 'plataformas', 'sucursales', 'prestaciones', 'asignaciones'].forEach(s => {
                document.getElementById(`section-${s}`).classList.add('section-hidden');
                document.getElementById(`tab-${s}`).classList.remove('tab-active');
                document.getElementById(`tab-${s}`).classList.add('text-gray-600');
            });
            document.getElementById(`section-${seccion}`).classList.remove('section-hidden');
            document.getElementById(`tab-${seccion}`).classList.add('tab-active');
            document.getElementById(`tab-${seccion}`).classList.remove('text-gray-600');
        }

        // SINCRONIZACI√ìN PRESTACIONES (3 NIVELES SIN SUCURSALES)
        async function sincronizarPrestaciones() {
            if (plataformas.length === 0) {
                mostrarToast('Crea una plataforma primero', 'warning');
                cambiarSeccion('plataformas');
                return;
            }

            mostrarProgreso('Iniciando sincronizaci√≥n...', 5);

            try {
                for (let p = 0; p < plataformas.length; p++) {
                    const plat = plataformas[p];
                    if (!plat.activa) continue;

                    const token = plat.token;
                    const idPlat = plat.id_plataforma;

                    mostrarProgreso(`Procesando plataforma: ${plat.zona}`, 10 + (p / plataformas.length * 10));

                    // NIVEL 1: Aranceles
                    const resAranceles = await fetch(`${DENTALINK_API}/aranceles`, {
                        headers: { 'Authorization': `Token ${token}`, 'Content-Type': 'application/json' }
                    });
                    if (!resAranceles.ok) continue;

                    const dataAranceles = await resAranceles.json();
                    const arancelesDL = (dataAranceles.data || []).filter(a => a.habilitado === 1);

                    mostrarProgreso(`${plat.zona}: ${arancelesDL.length} aranceles`, 20 + (p / plataformas.length * 10));

                    for (let i = 0; i < arancelesDL.length; i++) {
                        const arancel = arancelesDL[i];
                        const prog = 30 + ((i / arancelesDL.length) * 50);

                        // Guardar arancel
                        const datosArancel = {
                            id_arancel_dentalink: arancel.id,
                            id_plataforma: idPlat,
                            nombre: arancel.nombre,
                            habilitado: true
                        };

                        const resA = await fetch(`${SUPABASE_URL}/aranceles`, {
                            method: 'POST',
                            headers,
                            body: JSON.stringify(datosArancel)
                        });

                        if (!resA.ok && resA.status === 409) {
                            await fetch(`${SUPABASE_URL}/aranceles?id_arancel_dentalink=eq.${arancel.id}&id_plataforma=eq.${idPlat}`, {
                                method: 'PATCH',
                                headers,
                                body: JSON.stringify(datosArancel)
                            });
                        }

                        // Obtener id_arancel_interno que se cre√≥
                        const resArancelCreado = await fetch(`${SUPABASE_URL}/aranceles?id_arancel_dentalink=eq.${arancel.id}&id_plataforma=eq.${idPlat}&select=id_arancel_interno`, { headers });
                        const arancelCreado = await resArancelCreado.json();
                        const idArancelInterno = arancelCreado[0]?.id_arancel_interno;
                        if (!idArancelInterno) continue;

                        // NIVEL 2: Categor√≠as
                        const resCat = await fetch(`${DENTALINK_API}/aranceles/${arancel.id}/categorias`, {
                            headers: { 'Authorization': `Token ${token}`, 'Content-Type': 'application/json' }
                        });

                        if (!resCat.ok) continue;
                        const dataCat = await resCat.json();
                        const categoriasArancel = (dataCat.data || []).filter(c => c.habilitado === 1);

                        for (const cat of categoriasArancel) {
                            const datosCat = {
                                id_categoria_dentalink: cat.id,
                                id_arancel_interno: idArancelInterno,
                                nombre: cat.nombre,
                                id_tipo: cat.id_tipo,
                                tipo: cat.tipo,
                                habilitado: true
                            };

                            const resC = await fetch(`${SUPABASE_URL}/categorias`, {
                                method: 'POST',
                                headers,
                                body: JSON.stringify(datosCat)
                            });

                            if (!resC.ok && resC.status === 409) {
                                await fetch(`${SUPABASE_URL}/categorias?id_categoria_dentalink=eq.${cat.id}&id_arancel_interno=eq.${idArancelInterno}`, {
                                    method: 'PATCH',
                                    headers,
                                    body: JSON.stringify(datosCat)
                                });
                            }

                            // Obtener id_categoria_interno
                            const resCatCreada = await fetch(`${SUPABASE_URL}/categorias?id_categoria_dentalink=eq.${cat.id}&id_arancel_interno=eq.${idArancelInterno}&select=id_categoria_interno`, { headers });
                            const catCreada = await resCatCreada.json();
                            const idCatInterno = catCreada[0]?.id_categoria_interno;
                            if (!idCatInterno) continue;

                            // NIVEL 3: Prestaciones
                            const resPrest = await fetch(`${DENTALINK_API}/categorias/${cat.id}/prestaciones`, {
                                headers: { 'Authorization': `Token ${token}`, 'Content-Type': 'application/json' }
                            });

                            if (!resPrest.ok) continue;
                            const dataPrest = await resPrest.json();
                            const prestacionesCat = (dataPrest.data || []).filter(p => p.habilitado === 1);

                            for (const prest of prestacionesCat) {
                                const datosPrest = {
                                    id_prestacion_dentalink: prest.id,
                                    id_categoria_interno: idCatInterno,
                                    id_arancel_interno: idArancelInterno,
                                    nombre: prest.nombre,
                                    codigo: prest.codigo || null,
                                    precio: prest.precio || 0,
                                    habilitado: true,
                                    nombre_categoria: cat.nombre,
                                    nombre_arancel: arancel.nombre,
                                    tipo: cat.tipo
                                };

                                const resP = await fetch(`${SUPABASE_URL}/prestaciones`, {
                                    method: 'POST',
                                    headers,
                                    body: JSON.stringify(datosPrest)
                                });

                                if (!resP.ok && resP.status === 409) {
                                    await fetch(`${SUPABASE_URL}/prestaciones?id_prestacion_dentalink=eq.${prest.id}&id_categoria_interno=eq.${idCatInterno}`, {
                                        method: 'PATCH',
                                        headers,
                                        body: JSON.stringify(datosPrest)
                                    });
                                }
                            }
                        }

                        mostrarProgreso('', prog, `${arancel.nombre}: ${categoriasArancel.length} categor√≠as`);
                    }
                }

                mostrarProgreso('Finalizando...', 95);
                await cargarDatos();
                ocultarProgreso();
                mostrarToast('‚úÖ Sincronizaci√≥n completada');

            } catch (error) {
                console.error('Error:', error);
                ocultarProgreso();
                mostrarToast(`Error: ${error.message}`, 'error');
            }
        }

        // SINCRONIZAR SUCURSALES
        async function sincronizarSucursales() {
            if (plataformas.length === 0) {
                mostrarToast('Crea plataformas primero', 'warning');
                return;
            }

            const icon = document.getElementById('iconSyncSucursales');
            icon.classList.add('fa-spin');

            try {
                for (const plat of plataformas) {
                    if (!plat.activa) continue;

                    const res = await fetch(`${DENTALINK_API}/sucursales`, {
                        headers: { 'Authorization': `Token ${plat.token}`, 'Content-Type': 'application/json' }
                    });
                    if (!res.ok) continue;

                    const data = await res.json();
                    const sucsDL = data.data || [];

                    for (const suc of sucsDL) {
                        const datos = {
                            id_sucursal_dentalink: suc.id,
                            id_plataforma: plat.id_plataforma,
                            nombre_sucursal: suc.nombre,
                            ciudad: suc.ciudad || suc.comuna || 'Sin ciudad',
                            direccion: suc.direccion,
                            telefono: suc.telefono,
                            activa: suc.habilitada === 1
                        };

                        const resS = await fetch(`${SUPABASE_URL}/sucursales`, {
                            method: 'POST',
                            headers,
                            body: JSON.stringify(datos)
                        });

                        if (!resS.ok && resS.status === 409) {
                            await fetch(`${SUPABASE_URL}/sucursales?id_sucursal_dentalink=eq.${suc.id}&id_plataforma=eq.${plat.id_plataforma}`, {
                                method: 'PATCH',
                                headers,
                                body: JSON.stringify(datos)
                            });
                        }
                    }
                }

                await cargarDatos();
                icon.classList.remove('fa-spin');
                mostrarToast('‚úÖ Sucursales sincronizadas');

            } catch (error) {
                icon.classList.remove('fa-spin');
                mostrarToast(`Error: ${error.message}`, 'error');
            }
        }

        // RENDERIZADOS
        function renderizarTablaPlataformas() {
            const tbody = document.getElementById('tablaPlataformas');
            if (plataformas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No hay plataformas</td></tr>';
                return;
            }

            tbody.innerHTML = plataformas.map(p => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm font-medium">${p.zona}</td>
                    <td class="px-6 py-4 text-xs text-gray-500 font-mono">${p.token.substring(0, 20)}...</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${p.activa ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${p.activa ? '‚úì Activa' : '‚úó Inactiva'}
                        </span>
                    </td>
                    <td class="px-6 py-4 flex gap-2">
                        <button onclick="editarPlataforma(${p.id_plataforma})" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="eliminarPlataforma(${p.id_plataforma})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderizarTablaSucursales() {
            const tbody = document.getElementById('tablaSucursales');
            const filtro = document.getElementById('filtroPlataformaSucursales')?.value || '';
            const sucsFiltradas = filtro ? sucursales.filter(s => s.id_plataforma == filtro) : sucursales;

            if (sucsFiltradas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No hay sucursales</td></tr>';
                return;
            }

            tbody.innerHTML = sucsFiltradas.map(s => {
                const plat = plataformas.find(p => p.id_plataforma === s.id_plataforma);
                const numAranceles = arancelSucursal.filter(as => as.id_sucursal_interno === s.id_sucursal_interno).length;

                return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm font-medium">${s.nombre_sucursal}</td>
                    <td class="px-6 py-4 text-sm">${s.ciudad || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${plat?.zona || '-'}</td>
                    <td class="px-6 py-4 text-sm font-bold text-purple-600">${numAranceles}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${s.activa ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${s.activa ? '‚úì Activa' : '‚úó Inactiva'}
                        </span>
                    </td>
                </tr>
            `}).join('');
        }

        function filtrarSucursales() {
            renderizarTablaSucursales();
        }

        function aplicarFiltrosPrestaciones() {
            const plat = document.getElementById('filtroPlatPrest')?.value || '';
            const arancel = document.getElementById('filtroArancelPrest')?.value || '';
            const busqueda = document.getElementById('buscarPrestacion')?.value.toLowerCase() || '';

            prestacionesFiltradas = prestaciones.filter(p => {
                if (plat) {
                    const a = aranceles.find(ar => ar.id_arancel_interno === p.id_arancel_interno);
                    if (!a || a.id_plataforma != plat) return false;
                }
                if (arancel && p.id_arancel_interno != arancel) return false;
                if (busqueda && !p.nombre.toLowerCase().includes(busqueda)) return false;
                return true;
            });
        }

        function renderizarTablaPrestaciones() {
            const tbody = document.getElementById('tablaPrestaciones');
            if (prestacionesFiltradas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No hay prestaciones</td></tr>';
                document.getElementById('infoPrestaciones').textContent = '';
                document.getElementById('paginacionPrestaciones').innerHTML = '';
                return;
            }

            const totalPag = Math.ceil(prestacionesFiltradas.length / itemsPorPagina);
            const inicio = (paginaActual - 1) * itemsPorPagina;
            const fin = inicio + itemsPorPagina;
            const prestPagina = prestacionesFiltradas.slice(inicio, fin);

            tbody.innerHTML = prestPagina.map(p => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm">${p.nombre.substring(0, 60)}${p.nombre.length > 60 ? '...' : ''}</td>
                    <td class="px-4 py-3 text-xs">${p.nombre_categoria || '-'}</td>
                    <td class="px-4 py-3 text-sm font-bold text-green-600">$${Number(p.precio).toFixed(2)}</td>
                    <td class="px-4 py-3 text-xs">${p.nombre_arancel || '-'}</td>
                </tr>
            `).join('');

            document.getElementById('infoPrestaciones').textContent = 
                `Mostrando ${inicio + 1} - ${Math.min(fin, prestacionesFiltradas.length)} de ${prestacionesFiltradas.length}`;

            let paginacionHTML = '';
            if (paginaActual > 1) {
                paginacionHTML += `<button onclick="cambiarPagina(${paginaActual - 1})" class="px-3 py-1 border rounded hover:bg-gray-100">Anterior</button>`;
            }
            for (let i = Math.max(1, paginaActual - 2); i <= Math.min(totalPag, paginaActual + 2); i++) {
                paginacionHTML += `<button onclick="cambiarPagina(${i})" class="px-3 py-1 border rounded ${i === paginaActual ? 'bg-blue-600 text-white' : 'hover:bg-gray-100'}">${i}</button>`;
            }
            if (paginaActual < totalPag) {
                paginacionHTML += `<button onclick="cambiarPagina(${paginaActual + 1})" class="px-3 py-1 border rounded hover:bg-gray-100">Siguiente</button>`;
            }
            document.getElementById('paginacionPrestaciones').innerHTML = paginacionHTML;
        }

        function cambiarPagina(pagina) {
            paginaActual = pagina;
            renderizarTablaPrestaciones();
        }

        function filtrarPrestaciones() {
            aplicarFiltrosPrestaciones();
            paginaActual = 1;
            renderizarTablaPrestaciones();
        }

        function renderizarResumen() {
            const tbody = document.getElementById('tablaResumen');
            if (aranceles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No hay datos</td></tr>';
                return;
            }

            tbody.innerHTML = aranceles.map(a => {
                const plat = plataformas.find(p => p.id_plataforma === a.id_plataforma);
                const cats = categorias.filter(c => c.id_arancel_interno === a.id_arancel_interno).length;
                const prests = prestaciones.filter(p => p.id_arancel_interno === a.id_arancel_interno).length;
                const sucs = arancelSucursal.filter(as => as.id_arancel_interno === a.id_arancel_interno).length;

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm font-medium">${a.nombre}</td>
                        <td class="px-6 py-4 text-xs text-gray-600">${plat?.zona || '-'}</td>
                        <td class="px-6 py-4 text-sm font-bold text-purple-600">${cats}</td>
                        <td class="px-6 py-4 text-sm font-bold text-blue-600">${prests}</td>
                        <td class="px-6 py-4 text-sm font-bold text-green-600">${sucs}</td>
                    </tr>
                `;
            }).join('');
        }

        // ASIGNACIONES (NUEVA FUNCIONALIDAD)
        function renderizarAsignaciones() {
            const contenedor = document.getElementById('contenedorAsignaciones');
            if (sucursales.length === 0 || aranceles.length === 0) {
                contenedor.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-info-circle text-4xl mb-4"></i>
                        <p>Sincroniza sucursales y prestaciones primero</p>
                    </div>
                `;
                return;
            }

            // Inicializar asignacionesPendientes con datos actuales
            asignacionesPendientes = {};
            arancelSucursal.forEach(as => {
                if (!asignacionesPendientes[as.id_sucursal_interno]) {
                    asignacionesPendientes[as.id_sucursal_interno] = [];
                }
                asignacionesPendientes[as.id_sucursal_interno].push(as.id_arancel_interno);
            });

            contenedor.innerHTML = sucursales.map(s => {
                const plat = plataformas.find(p => p.id_plataforma === s.id_plataforma);
                const arancelesAsignados = asignacionesPendientes[s.id_sucursal_interno] || [];

                return `
                    <div class="border border-gray-200 rounded-lg p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-lg font-bold text-gray-800">${s.nombre_sucursal}</h4>
                                <p class="text-sm text-gray-500">${s.ciudad || 'Sin ciudad'} - ${plat?.zona || 'Sin plataforma'}</p>
                            </div>
                            <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm font-bold rounded-full">
                                ${arancelesAsignados.length} ${arancelesAsignados.length === 1 ? 'arancel' : 'aranceles'}
                            </span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            ${aranceles.map(a => {
                                const platArancel = plataformas.find(p => p.id_plataforma === a.id_plataforma);
                                const checked = arancelesAsignados.includes(a.id_arancel_interno);
                                return `
                                    <label class="flex items-start space-x-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition ${checked ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}">
                                        <input type="checkbox" 
                                               ${checked ? 'checked' : ''}
                                               onchange="toggleAsignacion(${s.id_sucursal_interno}, ${a.id_arancel_interno}, this.checked)"
                                               class="mt-1 w-4 h-4">
                                        <div class="flex-1">
                                            <p class="text-sm font-medium text-gray-800">${a.nombre}</p>
                                            <p class="text-xs text-gray-500">${platArancel?.zona || 'Sin plataforma'}</p>
                                        </div>
                                    </label>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleAsignacion(idSucursal, idArancel, agregar) {
            if (!asignacionesPendientes[idSucursal]) {
                asignacionesPendientes[idSucursal] = [];
            }

            if (agregar) {
                if (!asignacionesPendientes[idSucursal].includes(idArancel)) {
                    asignacionesPendientes[idSucursal].push(idArancel);
                }
            } else {
                asignacionesPendientes[idSucursal] = asignacionesPendientes[idSucursal].filter(a => a !== idArancel);
            }
        }

        async function guardarAsignaciones() {
            try {
                // Eliminar todas las asignaciones actuales
                await fetch(`${SUPABASE_URL}/arancel_sucursal`, {
                    method: 'DELETE',
                    headers
                });

                // Crear nuevas asignaciones
                const promesas = [];
                for (const [idSucursal, aranceles] of Object.entries(asignacionesPendientes)) {
                    for (const idArancel of aranceles) {
                        promesas.push(
                            fetch(`${SUPABASE_URL}/arancel_sucursal`, {
                                method: 'POST',
                                headers,
                                body: JSON.stringify({
                                    id_sucursal_interno: parseInt(idSucursal),
                                    id_arancel_interno: idArancel
                                })
                            })
                        );
                    }
                }

                await Promise.all(promesas);
                await cargarDatos();
                mostrarToast('‚úÖ Asignaciones guardadas correctamente');

            } catch (error) {
                console.error('Error:', error);
                mostrarToast('Error al guardar asignaciones', 'error');
            }
        }

        function llenarSelectsPlataforma() {
            const selectSuc = document.getElementById('filtroPlataformaSucursales');
            const selectPrest = document.getElementById('filtroPlatPrest');

            const opciones = '<option value="">Todas</option>' + 
                plataformas.map(p => `<option value="${p.id_plataforma}">${p.zona}</option>`).join('');

            if (selectSuc) selectSuc.innerHTML = opciones;
            if (selectPrest) {
                selectPrest.innerHTML = opciones;
                // Llenar select aranceles
                const selectArancel = document.getElementById('filtroArancelPrest');
                if (selectArancel) {
                    selectArancel.innerHTML = '<option value="">Todos</option>' +
                        aranceles.map(a => `<option value="${a.id_arancel_interno}">${a.nombre}</option>`).join('');
                }
            }
        }

        // MODALES
        function mostrarModalPlataforma() {
            document.getElementById('tituloModalPlataforma').textContent = 'Nueva Plataforma';
            document.getElementById('idPlataformaEditar').value = '';
            document.getElementById('formPlataforma').reset();
            document.getElementById('modalPlataforma').classList.remove('hidden');
        }

        function cerrarModalPlataforma() {
            document.getElementById('modalPlataforma').classList.add('hidden');
        }

        function editarPlataforma(id) {
            const p = plataformas.find(pl => pl.id_plataforma === id);
            if (!p) return;
            document.getElementById('tituloModalPlataforma').textContent = 'Editar Plataforma';
            document.getElementById('idPlataformaEditar').value = p.id_plataforma;
            document.getElementById('zonaPlataforma').value = p.zona;
            document.getElementById('tokenPlataforma').value = p.token;
            document.getElementById('activaPlataforma').value = p.activa.toString();
            document.getElementById('modalPlataforma').classList.remove('hidden');
        }

        async function guardarPlataforma(event) {
            event.preventDefault();
            const idEdit = document.getElementById('idPlataformaEditar').value;
            const datos = {
                zona: document.getElementById('zonaPlataforma').value,
                token: document.getElementById('tokenPlataforma').value,
                activa: document.getElementById('activaPlataforma').value === 'true'
            };

            try {
                if (idEdit) {
                    await fetch(`${SUPABASE_URL}/plataformas?id_plataforma=eq.${idEdit}`, {
                        method: 'PATCH',
                        headers,
                        body: JSON.stringify(datos)
                    });
                    mostrarToast('Plataforma actualizada');
                } else {
                    await fetch(`${SUPABASE_URL}/plataformas`, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify(datos)
                    });
                    mostrarToast('Plataforma creada');
                }
                cerrarModalPlataforma();
                await cargarDatos();
            } catch (error) {
                mostrarToast('Error al guardar', 'error');
            }
        }

        async function eliminarPlataforma(id) {
            if (!confirm('‚ö†Ô∏è ¬øEliminar plataforma y todos sus datos?')) return;
            try {
                await fetch(`${SUPABASE_URL}/plataformas?id_plataforma=eq.${id}`, {
                    method: 'DELETE',
                    headers
                });
                mostrarToast('Plataforma eliminada');
                await cargarDatos();
            } catch (error) {
                mostrarToast('Error al eliminar', 'error');
            }
        }
    </script>
</body>
</html>